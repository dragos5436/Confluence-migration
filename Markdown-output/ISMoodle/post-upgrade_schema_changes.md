# post-upgrade schema changes

``` java
ALTER TABLE moodle_int_management.sits_departments_dump ALTER COLUMN dpt_bdo_id SET DEFAULT '';
SET NAMES 'utf8mb4' COLLATE 'utf8mb4_0900_ai_ci';
/* Ordered re-creation */
DROP VIEW `moodle_int_management`.`sits_v_assignmentmerge`;
DROP VIEW `moodle_int_management`.`sits_v_departmentenrolment_add`;
DROP VIEW `moodle_int_management`.`sits_v_departmentenrolment_full`;
DROP VIEW `moodle_int_management`.`sits_v_departmentenrolment_rmv`;
DROP VIEW `moodle_int_management`.`sits_v_departmentmerge`;
DROP VIEW `moodle_int_management`.`sits_v_enrolcourse_ids`;
DROP VIEW `moodle_int_management`.`sits_v_enrolcourses`;
DROP VIEW `moodle_int_management`.`sits_v_enrolmembership_maps`;
DROP VIEW `moodle_int_management`.`sits_v_enrolmemberships`;
DROP VIEW `moodle_int_management`.`sits_v_enrolmemberships_add`;
DROP VIEW `moodle_int_management`.`sits_v_enrolmemberships_rmv`;
DROP VIEW `moodle_int_management`.`sits_v_enrolstudents`;
DROP VIEW `moodle_int_management`.`sits_v_facultyenrolment_add`;
DROP VIEW `moodle_int_management`.`sits_v_facultyenrolment_full`;
DROP VIEW `moodle_int_management`.`sits_v_facultyenrolment_rmv`;
DROP VIEW `moodle_int_management`.`sits_v_facultymerge`;
DROP VIEW `moodle_int_management`.`sits_v_mappings`;
DROP VIEW `moodle_int_management`.`sits_v_membershipmerge`;
DROP VIEW `moodle_int_management`.`sits_v_moduleenrolment_add`;
DROP VIEW `moodle_int_management`.`sits_v_moduleenrolment_full`;
DROP VIEW `moodle_int_management`.`sits_v_moduleenrolment_rmv`;
DROP VIEW `moodle_int_management`.`sits_v_modulemerge`;
DROP VIEW `moodle_int_management`.`sits_v_moduleoccmerge`;
DROP VIEW `moodle_int_management`.`sits_v_personaltutorrole`;
DROP VIEW `moodle_int_management`.`sits_v_preappmappings`;
DROP VIEW `moodle_int_management`.`sits_v_programmeenrolment_add`;
DROP VIEW `moodle_int_management`.`sits_v_programmeenrolment_full`;
DROP VIEW `moodle_int_management`.`sits_v_programmeenrolment_rmv`;
DROP VIEW `moodle_int_management`.`sits_v_programmemerge`;
DROP VIEW `moodle_int_management`.`sits_v_routeenrolment_add`;
DROP VIEW `moodle_int_management`.`sits_v_routeenrolment_full`;
DROP VIEW `moodle_int_management`.`sits_v_routeenrolment_rmv`;
DROP VIEW `moodle_int_management`.`sits_v_routemerge`;
DROP VIEW `moodle_int_management`.`sits_v_sitsdata`;
DROP VIEW `moodle_int_management`.`sits_v_studentmembershipconcat`;
DROP VIEW `moodle_int_management`.`sits_v_studentmerge`;
DROP VIEW `moodle_int_management`.`sits_v_studentuserprofiles`;
DROP VIEW `moodle_int_management`.`sits_v_thresholds`;

/* Recreate the ones with no dependencies */
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_thresholds` AS select 'students' AS `import_type`,count(`st`.`student_code`) AS `total_now`,count(`si`.`student_code`) AS `total_import`,`sp`.`setting` AS `threshold`,`so`.`setting` AS `override`,((count(`st`.`student_code`) * `sp`.`setting`) / 100) AS `threshold_check`,(case when (((count(`st`.`student_code`) * `sp`.`setting`) / 100) > count(`si`.`student_code`)) then 'breach' else 'safe' end) AS `threshold_action` from (((`moodle_int_management`.`sits_students` `st` join `moodle_int_management`.`system_settings` `sp` on((`sp`.`title` = 'threshold_percent'))) join `moodle_int_management`.`system_settings` `so` on((`so`.`title` = 'threshold_override'))) left join `moodle_int_management`.`sits_students_dump` `si` on((`st`.`student_code` = `si`.`student_code`))) where (`st`.`deleted` = 'N') group by `sp`.`setting`,`so`.`setting` union select 'memberships' AS `import_type`,count(`mm`.`student_code`) AS `total_now`,count(`mi`.`student_code`) AS `total_import`,`sp`.`setting` AS `threshold`,`so`.`setting` AS `override`,((count(`mm`.`student_code`) * `sp`.`setting`) / 100) AS `threshold_check`,(case when (((count(`mm`.`student_code`) * `sp`.`setting`) / 100) > count(`mi`.`student_code`)) then 'breach' else 'safe' end) AS `threshold_action` from (((`moodle_int_management`.`sits_memberships` `mm` join `moodle_int_management`.`system_settings` `sp` on((`sp`.`title` = 'threshold_percent'))) join `moodle_int_management`.`system_settings` `so` on((`so`.`title` = 'threshold_override'))) left join `moodle_int_management`.`sits_memberships_dump` `mi` on(((`mm`.`student_code` = `mi`.`student_code`) and (`mm`.`mod_occ_bdo_id` = `mi`.`mod_occ_bdo_id`)))) where (`mm`.`deleted` = 'N') group by `sp`.`setting`,`so`.`setting`;
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_studentmerge` AS select `im`.`student_code` AS `student_code`,`im`.`username` AS `username`,`im`.`upi` AS `upi`,`im`.`firstname` AS `firstname`,`im`.`surname` AS `surname`,`im`.`student_name` AS `student_name`,`im`.`email` AS `email`,`im`.`personal_tutor` AS `personal_tutor`,`im`.`dpt_bdo_id` AS `department_code`,`im`.`enrolment_status` AS `enrolment_status`,`im`.`course_join_status` AS `course_join_status`,coalesce(`es`.`enrol`,'N') AS `enrol`,`st`.`enrolment_status` AS `current_status`,`st`.`course_join_status` AS `current_coursejoin`,`st`.`deleted` AS `current_deleted`,if(isnull(`st`.`student_name`),'INS','UPD') AS `sync_action` from ((`moodle_int_management`.`sits_students_dump` `im` join `moodle_int_management`.`sits_enrolment_statuses` `es` on((`es`.`enrolment_status` = `im`.`enrolment_status`))) left join `moodle_int_management`.`sits_students` `st` on((`st`.`student_code` = `im`.`student_code`))) where (isnull(`st`.`student_code`) or (`st`.`username` <> `im`.`username`) or (`st`.`upi` <> `im`.`upi`) or (coalesce(`st`.`firstname`,'') <> coalesce(`im`.`firstname`,'')) or (`st`.`surname` <> `im`.`surname`) or (`st`.`student_name` <> `im`.`student_name`) or (`st`.`email` <> `im`.`email`) or (coalesce(`st`.`personal_tutor`,'') <> coalesce(`im`.`personal_tutor`,'')) or (coalesce(`st`.`dpt_bdo_id`,'') <> coalesce(`im`.`dpt_bdo_id`,'')) or (`st`.`enrolment_status` <> `im`.`enrolment_status`) or (`st`.`course_join_status` <> `im`.`course_join_status`) or (`st`.`deleted` = 'Y')) union select `st`.`student_code` AS `student_code`,`st`.`username` AS `username`,`st`.`upi` AS `upi`,`st`.`firstname` AS `firstname`,`st`.`surname` AS `surname`,`st`.`student_name` AS `student_name`,`st`.`email` AS `email`,`st`.`personal_tutor` AS `personal_tutor`,`st`.`dpt_bdo_id` AS `department_code`,`st`.`enrolment_status` AS `enrolment_status`,`st`.`course_join_status` AS `course_join_status`,NULL AS `enrol`,`st`.`enrolment_status` AS `current_status`,`st`.`course_join_status` AS `current_coursejoin`,`st`.`deleted` AS `current_deleted`,'DEL' AS `sync_action` from `moodle_int_management`.`sits_students` `st` where ((not(`st`.`student_code` in (select `im`.`student_code` from `moodle_int_management`.`sits_students_dump` `im`))) and (`st`.`deleted` <> 'Y'));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_sitsdata` AS select concat('FAC_',`fa`.`dpt_fac_code`) AS `map_id`,'FAC' AS `map_type`,`fa`.`dpt_fac_code` AS `map_code`,`fa`.`dpt_fac_code` AS `map_name`,NULL AS `ioe_sessions`,NULL AS `bdo_id`,NULL AS `year_code` from `moodle_int_management`.`sits_faculties` `fa` union select concat('PRG_',`pg`.`prog_code`) AS `map_id`,'PRG' AS `map_type`,`pg`.`prog_code` AS `map_code`,`pg`.`prog_name` AS `map_name`,`pg`.`ioe_sessions` AS `ioe_sessions`,NULL AS `bdo_id`,NULL AS `year_code` from `moodle_int_management`.`sits_programmes` `pg` union select concat('ROU_',`rt`.`route_code`) AS `map_id`,'ROU' AS `map_type`,`rt`.`route_code` AS `map_code`,`rt`.`route_name` AS `map_name`,`rt`.`ioe_sessions` AS `ioe_sessions`,NULL AS `bdo_id`,NULL AS `year_code` from `moodle_int_management`.`sits_routes` `rt` union select concat('MOD_',`md`.`mod_code`) AS `map_id`,'MOD' AS `map_type`,`md`.`mod_code` AS `map_code`,`md`.`mod_name` AS `map_name`,NULL AS `ioe_sessions`,`md`.`mod_inst_bdo_id` AS `bdo_id`,`md`.`mod_year_code` AS `year_code` from `moodle_int_management`.`sits_modules` `md` union select concat('MODOCC_',`mdo`.`mod_code`) AS `map_id`,'MODOCC' AS `map_type`,`mdo`.`mod_code` AS `map_code`,`mdo`.`mod_occ_name` AS `map_name`,NULL AS `ioe_sessions`,`mdo`.`mod_occ_bdo_id` AS `bdo_id`,`mdo`.`mod_occ_year_code` AS `year_code` from `moodle_int_management`.`sits_moduleoccurence` `mdo` union select concat('DPT_',`dpt`.`dpt_code`) AS `map_id`,'DPT' AS `map_type`,`dpt`.`dpt_code` AS `map_code`,`dpt`.`dpt_name` AS `map_name`,NULL AS `ioe_sessions`,`dpt`.`dpt_bdo_id` AS `bdo_id`,NULL AS `year_code` from `moodle_int_management`.`sits_departments` `dpt`;
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_routemerge` AS select `im`.`route_code` AS `route_code`,`im`.`route_name` AS `route_name`,`im`.`prog_code` AS `programme_code`,`im`.`dpt_bdo_id` AS `department_code`,`im`.`ioe_sessions` AS `ioe_sessions`,`rt`.`route_name` AS `current_name`,if(isnull(`rt`.`route_name`),'INS','UPD') AS `sync_action` from (`moodle_int_management`.`sits_routes_dump` `im` left join `moodle_int_management`.`sits_routes` `rt` on(((`rt`.`route_code` = `im`.`route_code`) and (`rt`.`prog_code` = `im`.`prog_code`) and (`rt`.`dpt_bdo_id` = `im`.`dpt_bdo_id`)))) where (isnull(`rt`.`route_code`) or (`rt`.`route_name` <> `im`.`route_name`) or (`rt`.`ioe_sessions` <> `im`.`ioe_sessions`) or (`rt`.`dpt_bdo_id` <> `im`.`dpt_bdo_id`)) union select `rt`.`route_code` AS `route_code`,`rt`.`route_name` AS `route_name`,`rt`.`prog_code` AS `programme_code`,`rt`.`dpt_bdo_id` AS `department_code`,`rt`.`ioe_sessions` AS `ioe_sessions`,`rt`.`route_name` AS `current_name`,'DEL' AS `sync_action` from `moodle_int_management`.`sits_routes` `rt` where (not((`rt`.`route_code`,`rt`.`prog_code`,`rt`.`dpt_bdo_id`) in (select `im`.`route_code`,`im`.`prog_code`,`im`.`dpt_bdo_id` from `moodle_int_management`.`sits_routes_dump` `im`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_programmemerge` AS select `im`.`prog_code` AS `programme_code`,`im`.`prog_name` AS `programme_name`,`im`.`dpt_bdo_id` AS `department_code`,`im`.`ioe_sessions` AS `ioe_sessions`,`pg`.`prog_name` AS `current_name`,if(isnull(`pg`.`prog_name`),'INS','UPD') AS `sync_action` from (`moodle_int_management`.`sits_programmes_dump` `im` left join `moodle_int_management`.`sits_programmes` `pg` on(((`pg`.`prog_code` = `im`.`prog_code`) and (`pg`.`dpt_bdo_id` = `im`.`dpt_bdo_id`)))) where (isnull(`pg`.`prog_code`) or (`pg`.`prog_name` <> `im`.`prog_name`) or (`pg`.`ioe_sessions` <> `im`.`ioe_sessions`) or (`pg`.`dpt_bdo_id` <> `im`.`dpt_bdo_id`)) union select `pg`.`prog_code` AS `programme_code`,`pg`.`prog_name` AS `programme_name`,`pg`.`dpt_bdo_id` AS `department_code`,`pg`.`ioe_sessions` AS `ioe_sessions`,`pg`.`prog_name` AS `current_name`,'DEL' AS `sync_action` from `moodle_int_management`.`sits_programmes` `pg` where (not((`pg`.`prog_code`,`pg`.`dpt_bdo_id`) in (select `im`.`prog_code`,`im`.`dpt_bdo_id` from `moodle_int_management`.`sits_programmes_dump` `im`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_preappmappings` AS select `mdo`.`vle_courseid` AS `vle_courseid`,`mdo`.`vle_idnumber` AS `moodle_idnumber`,`mdo`.`mod_occ_bdo_id` AS `mapping_code`,`mdo`.`reg_status` AS `reg_status`,`mdo`.`mapping_action` AS `mapping_action`,'module' AS `mapping_type` from `moodle_int_management`.`sits_moduleoccurence_mapping` `mdo` where ((`mdo`.`mapping_action` = 'ADD') and (`mdo`.`reg_status` = 'NEW')) union select `dpt`.`vle_courseid` AS `vle_courseid`,`dpt`.`vle_idnumber` AS `vle_idnumber`,`dpt`.`dpt_bdo_id` AS `department_code`,`dpt`.`reg_status` AS `reg_status`,`dpt`.`mapping_action` AS `mapping_action`,'department' AS `mapping_type` from `moodle_int_management`.`sits_departments_mapping` `dpt` where ((`dpt`.`mapping_action` = 'ADD') and (`dpt`.`reg_status` = 'NEW'));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_personaltutorrole` AS select `st`.`student_code` AS `student_code`,`st`.`upi` AS `student_upi`,`st`.`username` AS `student_username`,`st`.`firstname` AS `student_firstname`,`st`.`surname` AS `student_surname`,`gn`.`prog_code` AS `student_programme`,`us`.`id` AS `student_id`,`st`.`personal_tutor` AS `sits_tutor_upi`,`nd`.`data` AS `tutor_upi`,`up`.`firstname` AS `tutor_firstname`,`up`.`lastname` AS `tutor_surname`,`up`.`id` AS `tutor_id`,'personal_tutor' AS `role`,'profile_fields' AS `source` from ((((((`moodle_int_management`.`sits_students` `st` join `moodle_int_management`.`sits_enrolment_statuses` `en` on(((`en`.`enrolment_status` = `st`.`enrolment_status`) and (`en`.`enrol` = 'Y')))) join `moodle_int_management`.`sits_assignments` `gn` on(((`gn`.`student_code` = `st`.`student_code`) and (`gn`.`active` = 'Y')))) join `uclmoodleprod`.`mdl_user_info_data` `nd` on((upper(`nd`.`data`) = `st`.`personal_tutor`))) join `uclmoodleprod`.`mdl_user_info_field` `nf` on(((`nf`.`id` = `nd`.`fieldid`) and (`nf`.`shortname` = 'upi')))) left join `uclmoodleprod`.`mdl_user` `us` on((`st`.`student_code` = `us`.`idnumber`))) left join `uclmoodleprod`.`mdl_user` `up` on((`nd`.`userid` = `up`.`id`))) where ((`st`.`deleted` = 'N') and (`st`.`personal_tutor` is not null) and (`st`.`personal_tutor` <> ''));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_moduleoccmerge` AS select `im`.`mod_occ_bdo_id` AS `module_occ_bdo_id`,`im`.`mod_inst_bdo_id` AS `module_instance_bdo_id`,`im`.`mod_code` AS `module_code`,`im`.`mod_occ_name` AS `module_occ_name`,`im`.`mod_occ_psl_code` AS `module_occ_psl_code`,`im`.`mod_occ_mav` AS `module_occ_mav`,`im`.`mod_occ_year_code` AS `module_occ_year_code`,`mdo`.`mod_code` AS `current_mod_code`,`mdo`.`mod_occ_name` AS `current_name`,`mdo`.`mod_occ_psl_code` AS `current_mod_occ_psl_code`,`mdo`.`mod_occ_mav` AS `current_mod_occ_mav`,`mdo`.`mod_occ_year_code` AS `current_mod_occ_year_code`,if(isnull(`mdo`.`mod_occ_bdo_id`),'INS','UPD') AS `sync_action` from (`moodle_int_management`.`sits_moduleoccurence_dump` `im` left join `moodle_int_management`.`sits_moduleoccurence` `mdo` on((`mdo`.`mod_occ_bdo_id` = `im`.`mod_occ_bdo_id`))) where (isnull(`mdo`.`mod_occ_bdo_id`) or (`mdo`.`mod_inst_bdo_id` <> `im`.`mod_inst_bdo_id`) or (`mdo`.`mod_code` <> `im`.`mod_code`) or (`mdo`.`mod_occ_name` <> `im`.`mod_occ_name`) or (`mdo`.`mod_occ_psl_code` <> `im`.`mod_occ_psl_code`) or (`mdo`.`mod_occ_mav` <> `im`.`mod_occ_mav`) or (`mdo`.`mod_occ_year_code` <> `im`.`mod_occ_year_code`)) union select `mdo`.`mod_occ_bdo_id` AS `module_occ_bdo_id`,`mdo`.`mod_inst_bdo_id` AS `module_instance_bdo_id`,`mdo`.`mod_code` AS `module_code`,`mdo`.`mod_occ_name` AS `module_occ_name`,`mdo`.`mod_occ_psl_code` AS `module_occ_psl_code`,`mdo`.`mod_occ_mav` AS `module_occ_mav`,`mdo`.`mod_occ_year_code` AS `module_occ_year_code`,`mdo`.`mod_code` AS `current_mod_code`,`mdo`.`mod_occ_name` AS `current_name`,`mdo`.`mod_occ_psl_code` AS `current_mod_occ_psl_code`,`mdo`.`mod_occ_mav` AS `current_mod_occ_mav`,`mdo`.`mod_occ_year_code` AS `current_mod_occ_year_code`,'DEL' AS `sync_action` from `moodle_int_management`.`sits_moduleoccurence` `mdo` where (not(`mdo`.`mod_occ_bdo_id` in (select `im`.`mod_occ_bdo_id` from `moodle_int_management`.`sits_moduleoccurence_dump` `im`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_modulemerge` AS select `im`.`mod_inst_bdo_id` AS `module_instance_bdo_id`,`im`.`mod_bdo_id` AS `module_bdo_id`,`im`.`mod_code` AS `module_code`,`im`.`mod_name` AS `module_name`,`im`.`mod_dpt_bdo_id` AS `department_code`,`im`.`mod_year_code` AS `year_code`,`md`.`mod_code` AS `current_mod_code`,`md`.`mod_name` AS `current_name`,`md`.`mod_dpt_bdo_id` AS `current_department`,if(isnull(`md`.`mod_name`),'INS','UPD') AS `sync_action` from (`moodle_int_management`.`sits_modules_dump` `im` left join `moodle_int_management`.`sits_modules` `md` on((`md`.`mod_inst_bdo_id` = `im`.`mod_inst_bdo_id`))) where (isnull(`md`.`mod_inst_bdo_id`) or (`md`.`mod_code` <> `im`.`mod_code`) or (`md`.`mod_name` <> `im`.`mod_name`) or (`md`.`mod_dpt_bdo_id` <> `im`.`mod_dpt_bdo_id`)) union select `md`.`mod_inst_bdo_id` AS `module_instance_bdo_id`,`md`.`mod_bdo_id` AS `module_bdo_id`,`md`.`mod_code` AS `module_code`,`md`.`mod_name` AS `module_name`,`md`.`mod_dpt_bdo_id` AS `department_code`,`md`.`mod_year_code` AS `year_code`,`md`.`mod_code` AS `current_mod_code`,`md`.`mod_name` AS `current_name`,`md`.`mod_dpt_bdo_id` AS `current_department`,'DEL' AS `sync_action` from `moodle_int_management`.`sits_modules` `md` where (not(`md`.`mod_inst_bdo_id` in (select `im`.`mod_inst_bdo_id` from `moodle_int_management`.`sits_modules_dump` `im`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_membershipmerge` AS select `im`.`student_code` AS `student_code`,`im`.`mod_occ_bdo_id` AS `module_occ_code`,`im`.`mod_dpt_bdo_id` AS `department_code`,`im`.`reg_status` AS `reg_status`,`im`.`smo_sms` AS `smo_sms`,`mm`.`reg_status` AS `current_status`,`mm`.`smo_sms` AS `current_source`,`mm`.`deleted` AS `current_deleted`,if(isnull(`mm`.`student_code`),'INS','UPD') AS `sync_action` from (`moodle_int_management`.`sits_memberships_dump` `im` left join `moodle_int_management`.`sits_memberships` `mm` on(((`mm`.`student_code` = `im`.`student_code`) and (`mm`.`mod_occ_bdo_id` = `im`.`mod_occ_bdo_id`)))) where (isnull(`mm`.`student_code`) or (`mm`.`reg_status` <> `im`.`reg_status`) or (`mm`.`smo_sms` <> `im`.`smo_sms`) or (`mm`.`deleted` = 'Y')) union select `mm`.`student_code` AS `student_code`,`mm`.`mod_occ_bdo_id` AS `module_occ_code`,`mm`.`mod_dpt_bdo_id` AS `department_code`,`mm`.`reg_status` AS `reg_status`,`mm`.`smo_sms` AS `smo_sms`,`mm`.`reg_status` AS `current_status`,`mm`.`smo_sms` AS `current_source`,`mm`.`deleted` AS `current_deleted`,'DEL' AS `sync_action` from `moodle_int_management`.`sits_memberships` `mm` where ((not((`mm`.`student_code`,`mm`.`mod_occ_bdo_id`,`mm`.`mod_dpt_bdo_id`) in (select `im`.`student_code`,`im`.`mod_occ_bdo_id`,`im`.`mod_dpt_bdo_id` from `moodle_int_management`.`sits_memberships_dump` `im`))) and (`mm`.`deleted` <> 'Y'));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_mappings` AS select concat('FAC_',`mp`.`dpt_fac_code`,'_',ifnull(`mp`.`course_year`,'')) AS `map_id`,`mp`.`vle_courseid` AS `vle_courseid`,`mp`.`vle_idnumber` AS `vle_idnumber`,`mp`.`mapping_action` AS `mapping_action`,`ms`.`mapping_active` AS `mapping_active`,`mp`.`dpt_fac_code` AS `map_code`,'FAC' AS `map_type`,`fc`.`dpt_fac_code` AS `source_code`,`fc`.`dpt_fac_name` AS `map_name`,NULL AS `ioe_sessions`,`mp`.`course_year` AS `map_year`,NULL AS `map_regstatus`,NULL AS `map_session`,NULL AS `group_import` from ((`moodle_int_management`.`sits_faculties_mapping` `mp` join `moodle_int_management`.`sits_mapping_statuses` `ms` on((`ms`.`vle_courseid` = `mp`.`vle_courseid`))) left join `moodle_int_management`.`sits_faculties` `fc` on((`fc`.`dpt_fac_code` = `mp`.`dpt_fac_code`))) union select concat('PRG_',`mp`.`prog_code`,'_',ifnull(`mp`.`course_year`,''),'_',ifnull(`mp`.`ioe_sessions`,'')) AS `map_id`,`mp`.`vle_courseid` AS `vle_courseid`,`mp`.`vle_idnumber` AS `vle_idnumber`,`mp`.`mapping_action` AS `mapping_action`,`ms`.`mapping_active` AS `mapping_active`,`mp`.`prog_code` AS `map_code`,'PRG' AS `map_type`,`pg`.`prog_code` AS `source_code`,`pg`.`prog_name` AS `programme_name`,`pg`.`ioe_sessions` AS `ioe_sessions`,`mp`.`course_year` AS `course_year`,NULL AS `map_regstatus`,`mp`.`ioe_sessions` AS `ioe_session`,NULL AS `group_import` from ((`moodle_int_management`.`sits_programmes_mapping` `mp` join `moodle_int_management`.`sits_mapping_statuses` `ms` on((`ms`.`vle_courseid` = `mp`.`vle_courseid`))) left join `moodle_int_management`.`sits_programmes` `pg` on((`pg`.`prog_code` = `mp`.`prog_code`))) union select concat('ROU_',`mp`.`route_code`,'_',ifnull(`mp`.`course_year`,''),'_',ifnull(`mp`.`ioe_sessions`,'')) AS `map_id`,`mp`.`vle_courseid` AS `vle_courseid`,`mp`.`vle_idnumber` AS `vle_idnumber`,`mp`.`mapping_action` AS `mapping_action`,`ms`.`mapping_active` AS `mapping_active`,`mp`.`route_code` AS `map_code`,'ROU' AS `map_type`,`rt`.`route_code` AS `source_code`,`rt`.`route_name` AS `route_name`,`rt`.`ioe_sessions` AS `ioe_sessions`,`mp`.`course_year` AS `course_year`,NULL AS `map_regstatus`,`mp`.`ioe_sessions` AS `ioe_session`,NULL AS `group_import` from ((`moodle_int_management`.`sits_routes_mapping` `mp` join `moodle_int_management`.`sits_mapping_statuses` `ms` on((`ms`.`vle_courseid` = `mp`.`vle_courseid`))) left join `moodle_int_management`.`sits_routes` `rt` on((`rt`.`route_code` = `mp`.`route_code`))) union select concat('MODOCC_',`mp`.`mod_code`) AS `map_id`,`mp`.`vle_courseid` AS `vle_courseid`,`mp`.`vle_idnumber` AS `vle_idnumber`,`mp`.`mapping_action` AS `mapping_action`,`ms`.`mapping_active` AS `mapping_active`,`mp`.`mod_occ_bdo_id` AS `map_code`,'MODOCC' AS `map_type`,`mdo`.`mod_code` AS `source_code`,`mdo`.`mod_occ_name` AS `module_name`,NULL AS `ioe_sessions`,NULL AS `map_year`,`mp`.`reg_status` AS `reg_status`,NULL AS `ioe_session`,`mp`.`group_import` AS `group_import` from (((`moodle_int_management`.`sits_moduleoccurence_mapping` `mp` join `moodle_int_management`.`sits_mapping_statuses` `ms` on((`ms`.`vle_courseid` = `mp`.`vle_courseid`))) left join `moodle_int_management`.`sits_moduleoccurence` `mdo` on((`mdo`.`mod_occ_bdo_id` = `mp`.`mod_occ_bdo_id`))) join `moodle_int_management`.`sits_modules` `md` on((`md`.`mod_inst_bdo_id` = `mdo`.`mod_inst_bdo_id`))) union select concat('DPT_',`mp`.`dpt_code`,'_',ifnull(`mp`.`course_year`,'')) AS `map_id`,`mp`.`vle_courseid` AS `vle_courseid`,`mp`.`vle_idnumber` AS `vle_idnumber`,`mp`.`mapping_action` AS `mapping_action`,`ms`.`mapping_active` AS `mapping_active`,`mp`.`dpt_bdo_id` AS `map_code`,'DPT' AS `map_type`,`dp`.`dpt_code` AS `source_code`,`dp`.`dpt_name` AS `department_name`,NULL AS `ioe_sessions`,`mp`.`course_year` AS `course_year`,`mp`.`reg_status` AS `reg_status`,NULL AS `ioe_session`,NULL AS `group_import` from ((`moodle_int_management`.`sits_departments_mapping` `mp` join `moodle_int_management`.`sits_mapping_statuses` `ms` on((`ms`.`vle_courseid` = `mp`.`vle_courseid`))) left join `moodle_int_management`.`sits_departments` `dp` on((`dp`.`dpt_bdo_id` = `mp`.`dpt_bdo_id`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_facultymerge` AS select `fi`.`dpt_fac_code` AS `faculty_code`,`fi`.`dpt_fac_name` AS `faculty_name`,`fa`.`dpt_fac_name` AS `current_name`,if(isnull(`fa`.`dpt_fac_name`),'INS','UPD') AS `sync_action` from (`moodle_int_management`.`sits_faculties_dump` `fi` left join `moodle_int_management`.`sits_faculties` `fa` on((`fa`.`dpt_fac_code` = `fi`.`dpt_fac_code`))) where (isnull(`fa`.`dpt_fac_code`) or (`fa`.`dpt_fac_name` <> `fi`.`dpt_fac_name`)) union select `fa`.`dpt_fac_code` AS `faculty_code`,`fa`.`dpt_fac_name` AS `faculty_name`,`fa`.`dpt_fac_name` AS `current_name`,'DEL' AS `sync_action` from `moodle_int_management`.`sits_faculties` `fa` where (not(`fa`.`dpt_fac_code` in (select `fi`.`dpt_fac_code` from `moodle_int_management`.`sits_faculties_dump` `fi`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_departmentmerge` AS select `im`.`dpt_bdo_id` AS `department_bdo_id`,`im`.`dpt_code` AS `department_code`,`im`.`dpt_name` AS `department_name`,`im`.`dpt_fac_code` AS `faculty_code`,`dp`.`dpt_name` AS `current_name`,`dp`.`dpt_fac_code` AS `current_faculty`,if(isnull(`dp`.`dpt_name`),'INS','UPD') AS `sync_action` from (`moodle_int_management`.`sits_departments_dump` `im` left join `moodle_int_management`.`sits_departments` `dp` on((`dp`.`dpt_bdo_id` = `im`.`dpt_bdo_id`))) where (isnull(`dp`.`dpt_bdo_id`) or (`dp`.`dpt_code` <> `im`.`dpt_code`) or (`dp`.`dpt_name` <> `im`.`dpt_name`) or (`dp`.`dpt_fac_code` <> `im`.`dpt_fac_code`)) union select `dp`.`dpt_bdo_id` AS `department_bdo_id`,`dp`.`dpt_code` AS `department_code`,`dp`.`dpt_name` AS `department_name`,`dp`.`dpt_fac_code` AS `faculty_code`,`dp`.`dpt_name` AS `current_name`,`dp`.`dpt_fac_code` AS `current_faculty`,'DEL' AS `sync_action` from `moodle_int_management`.`sits_departments` `dp` where (not(`dp`.`dpt_bdo_id` in (select `im`.`dpt_bdo_id` from `moodle_int_management`.`sits_departments_dump` `im`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_assignmentmerge` AS select `im`.`student_code` AS `student_code`,`im`.`route_code` AS `route_code`,`im`.`prog_code` AS `programme_code`,`im`.`dpt_bdo_id` AS `department_code`,`im`.`dpt_fac_code` AS `faculty_code`,`im`.`post_undergrad` AS `post_undergrad`,`im`.`course_year` AS `course_year`,`ag`.`id` AS `current_id`,`ag`.`route_code` AS `current_route`,`ag`.`dpt_bdo_id` AS `current_department`,`ag`.`course_year` AS `current_year`,if(isnull(`ag`.`student_code`),'INS','UPD') AS `sync_action` from (`moodle_int_management`.`sits_assignments_dump` `im` left join `moodle_int_management`.`sits_assignments` `ag` on(((`ag`.`student_code` = `im`.`student_code`) and (`ag`.`active` = 'Y')))) where (isnull(`ag`.`student_code`) or (`ag`.`route_code` <> `im`.`route_code`) or (`ag`.`prog_code` <> `im`.`prog_code`) or (coalesce(`ag`.`dpt_bdo_id`,'') <> coalesce(`im`.`dpt_bdo_id`,'')) or (coalesce(`ag`.`dpt_fac_code`,'') <> coalesce(`im`.`dpt_fac_code`,'')) or (`ag`.`post_undergrad` <> `im`.`post_undergrad`) or (`ag`.`course_year` <> `im`.`course_year`)) union select `ag`.`student_code` AS `student_code`,`ag`.`route_code` AS `route_code`,`ag`.`prog_code` AS `programme_code`,`ag`.`dpt_bdo_id` AS `department_code`,`ag`.`dpt_fac_code` AS `faculty_code`,`ag`.`post_undergrad` AS `post_undergrad`,`ag`.`course_year` AS `course_year`,`ag`.`id` AS `current_id`,`ag`.`route_code` AS `current_route`,`ag`.`dpt_bdo_id` AS `current_department`,`ag`.`course_year` AS `current_year`,'DEL' AS `sync_action` from `moodle_int_management`.`sits_assignments` `ag` where (not(`ag`.`student_code` in (select `im`.`student_code` from `moodle_int_management`.`sits_assignments_dump` `im`)));
 
/* Recreate the ones with no dependencies */
/*self contained*/
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_studentmembershipconcat` AS select `mem`.`student_code` AS `student_code`,group_concat(distinct `smo`.`mod_code` order by `smo`.`mod_code` ASC separator ',') AS `modulelist`,'approved' AS `type` from (`moodle_int_management`.`sits_memberships` `mem` join `moodle_int_management`.`sits_moduleoccurence` `smo` on((`mem`.`mod_occ_bdo_id` = `smo`.`mod_occ_bdo_id`))) where ((`mem`.`reg_status` in ('CON','APP')) and (`mem`.`deleted` = 'N')) group by `mem`.`student_code` union select `mem`.`student_code` AS `student_code`,group_concat(distinct `smo`.`mod_code` order by `smo`.`mod_code` ASC separator ',') AS `modulelist`,'preapproved' AS `type` from (`moodle_int_management`.`sits_memberships` `mem` join `moodle_int_management`.`sits_moduleoccurence_mapping` `smo` on((`mem`.`mod_occ_bdo_id` = `smo`.`mod_occ_bdo_id`))) where ((`mem`.`reg_status` = 'NEW') and (`mem`.`deleted` = 'N')) group by `mem`.`student_code` order by `student_code`;
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_studentuserprofiles` AS select `st`.`username` AS `username`,`st`.`firstname` AS `firstname`,`st`.`surname` AS `lastname`,`st`.`email` AS `email`,`st`.`student_code` AS `idnumber`,`st`.`upi` AS `profile_field_upi`,`ag`.`prog_code` AS `profile_field_programmecode`,`pg`.`prog_name` AS `profile_field_programmename`,`ag`.`course_year` AS `profile_field_courseyear`,`ma`.`modulelist` AS `profile_field_approvedmodules`,`mp`.`modulelist` AS `profile_field_preappmodules`,(case `ag`.`post_undergrad` when 'P' then 'PG' when 'U' then 'UG' end) AS `profile_field_postundergrad` from (((((`moodle_int_management`.`sits_students` `st` join `moodle_int_management`.`sits_enrolment_statuses` `en` on(((`en`.`enrolment_status` = `st`.`enrolment_status`) and (`en`.`enrol` = 'Y')))) left join `moodle_int_management`.`sits_assignments` `ag` on(((`ag`.`student_code` = `st`.`student_code`) and (`ag`.`active` = 'Y')))) left join `moodle_int_management`.`sits_programmes` `pg` on((`pg`.`prog_code` = `ag`.`prog_code`))) left join `moodle_int_management`.`sits_v_studentmembershipconcat` `ma` on(((`st`.`student_code` = `ma`.`student_code`) and (`ma`.`type` = 'approved')))) left join `moodle_int_management`.`sits_v_studentmembershipconcat` `mp` on(((`st`.`student_code` = `mp`.`student_code`) and (`mp`.`type` = 'preapproved')))) where ((`st`.`deleted` = 'N') and (`st`.`course_join_status` = 'O') and (`st`.`username` <> '') and (`st`.`username` is not null));
 
/*interdependent layer 1*/
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_facultyenrolment_full` AS select `mp`.`dpt_fac_code` AS `map_faculty`,`mp`.`course_year` AS `map_year`,`mp`.`vle_idnumber` AS `vle_idnumber`,`mp`.`vle_courseid` AS `vle_courseid`,`mp`.`mapping_action` AS `mapping_action`,`ag`.`student_code` AS `student_code`,`st`.`username` AS `username`,`ag`.`dpt_fac_code` AS `faculty_code`,`ag`.`course_year` AS `course_year`,`ag`.`post_undergrad` AS `post_undergrad`,`ag`.`active` AS `assignment_active`,`st`.`enrolment_status` AS `enrolment_status`,`st`.`course_join_status` AS `course_join_status`,`st`.`deleted` AS `student_deleted`,`es`.`enrol` AS `enrol` from ((((`moodle_int_management`.`sits_faculties_mapping` `mp` join `moodle_int_management`.`sits_mapping_statuses` `ms` on(((`ms`.`vle_courseid` = `mp`.`vle_courseid`) and (`ms`.`mapping_active` = 'Y')))) join `moodle_int_management`.`sits_assignments` `ag` on(((`ag`.`dpt_fac_code` = `mp`.`dpt_fac_code`) and (((`ag`.`post_undergrad` = 'U') and (`ag`.`course_year` = `mp`.`course_year`)) or (`ag`.`post_undergrad` = `mp`.`course_year`) or isnull(`mp`.`course_year`))))) join `moodle_int_management`.`sits_students` `st` on((`st`.`student_code` = `ag`.`student_code`))) join `moodle_int_management`.`sits_enrolment_statuses` `es` on((`es`.`enrolment_status` = `st`.`enrolment_status`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_programmeenrolment_full` AS select `mp`.`prog_code` AS `map_programme`,`mp`.`course_year` AS `map_year`,`mp`.`ioe_sessions` AS `map_session`,`ss`.`description` AS `session_desc`,`ss`.`session_suffix` AS `session_suffix`,`mp`.`vle_idnumber` AS `vle_idnumber`,`mp`.`vle_courseid` AS `vle_courseid`,`mp`.`mapping_action` AS `mapping_action`,`ag`.`student_code` AS `student_code`,`st`.`username` AS `username`,`ag`.`prog_code` AS `programme_code`,`ag`.`course_year` AS `course_year`,`ag`.`post_undergrad` AS `post_undergrad`,`ag`.`active` AS `assignment_active`,`st`.`enrolment_status` AS `enrolment_status`,`st`.`course_join_status` AS `course_join_status`,`st`.`deleted` AS `student_deleted`,`es`.`enrol` AS `enrol` from (((((`moodle_int_management`.`sits_programmes_mapping` `mp` join `moodle_int_management`.`sits_mapping_statuses` `ms` on(((`ms`.`vle_courseid` = `mp`.`vle_courseid`) and (`ms`.`mapping_active` = 'Y')))) left join `moodle_int_management`.`sits_start_sessions` `ss` on((`ss`.`session_code` = `mp`.`ioe_sessions`))) join `moodle_int_management`.`sits_assignments` `ag` on(((`ag`.`prog_code` = `mp`.`prog_code`) and ((isnull(`mp`.`course_year`) and isnull(`mp`.`ioe_sessions`)) or ((substr(`ag`.`course_year`,1,1) = `mp`.`course_year`) and isnull(`mp`.`ioe_sessions`)) or ((`mp`.`ioe_sessions` is not null) and isnull(`mp`.`course_year`) and ((substr(`ag`.`course_year`,-(1)) = `ss`.`session_suffix`) or (isnull(`ss`.`session_suffix`) and (length(`ag`.`course_year`) = 1)))) or ((`mp`.`ioe_sessions` is not null) and (`mp`.`course_year` is not null) and (`ag`.`course_year` = concat(`mp`.`course_year`,coalesce(`ss`.`session_suffix`,'')))))))) join `moodle_int_management`.`sits_students` `st` on((`st`.`student_code` = `ag`.`student_code`))) join `moodle_int_management`.`sits_enrolment_statuses` `es` on((`es`.`enrolment_status` = `st`.`enrolment_status`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_routeenrolment_full` AS select `mp`.`route_code` AS `map_route`,`mp`.`course_year` AS `map_year`,`mp`.`ioe_sessions` AS `map_session`,`ss`.`description` AS `session_desc`,`ss`.`session_suffix` AS `session_suffix`,`mp`.`vle_idnumber` AS `vle_idnumber`,`mp`.`vle_courseid` AS `vle_courseid`,`mp`.`mapping_action` AS `mapping_action`,`ag`.`student_code` AS `student_code`,`st`.`username` AS `username`,`ag`.`route_code` AS `route_code`,`ag`.`course_year` AS `course_year`,`ag`.`post_undergrad` AS `post_undergrad`,`ag`.`active` AS `assignment_active`,`st`.`enrolment_status` AS `enrolment_status`,`st`.`course_join_status` AS `course_join_status`,`st`.`deleted` AS `student_deleted`,`es`.`enrol` AS `enrol` from (((((`moodle_int_management`.`sits_routes_mapping` `mp` join `moodle_int_management`.`sits_mapping_statuses` `ms` on(((`ms`.`vle_courseid` = `mp`.`vle_courseid`) and (`ms`.`mapping_active` = 'Y')))) left join `moodle_int_management`.`sits_start_sessions` `ss` on((`ss`.`session_code` = `mp`.`ioe_sessions`))) join `moodle_int_management`.`sits_assignments` `ag` on(((`ag`.`route_code` = `mp`.`route_code`) and ((isnull(`mp`.`course_year`) and isnull(`mp`.`ioe_sessions`)) or ((substr(`ag`.`course_year`,1,1) = `mp`.`course_year`) and isnull(`mp`.`ioe_sessions`)) or ((`mp`.`ioe_sessions` is not null) and isnull(`mp`.`course_year`) and ((substr(`ag`.`course_year`,-(1)) = `ss`.`session_suffix`) or (isnull(`ss`.`session_suffix`) and (length(`ag`.`course_year`) = 1)))) or ((`mp`.`ioe_sessions` is not null) and (`mp`.`course_year` is not null) and (`ag`.`course_year` = concat(`mp`.`course_year`,coalesce(`ss`.`session_suffix`,'')))))))) join `moodle_int_management`.`sits_students` `st` on((`st`.`student_code` = `ag`.`student_code`))) join `moodle_int_management`.`sits_enrolment_statuses` `es` on((`es`.`enrolment_status` = `st`.`enrolment_status`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_moduleenrolment_full` AS select `mp`.`mod_occ_bdo_id` AS `map_module`,`mp`.`reg_status` AS `map_reg`,`mr`.`level` AS `map_level`,`mp`.`vle_courseid` AS `vle_courseid`,`mp`.`vle_idnumber` AS `vle_idnumber`,`mp`.`mapping_action` AS `mapping_action`,`mm`.`student_code` AS `student_code`,`st`.`username` AS `username`,`mp`.`mod_code` AS `module_code`,`mm`.`reg_status` AS `reg_status`,`mm`.`deleted` AS `membership_deleted`,`rs`.`level` AS `reg_level`,`st`.`enrolment_status` AS `enrolment_status`,`st`.`course_join_status` AS `course_join_status`,`st`.`deleted` AS `student_deleted`,`es`.`enrol` AS `enrol` from ((((((`moodle_int_management`.`sits_moduleoccurence_mapping` `mp` join `moodle_int_management`.`sits_mapping_statuses` `ms` on(((`ms`.`vle_courseid` = `mp`.`vle_courseid`) and (`ms`.`mapping_active` = 'Y')))) join `moodle_int_management`.`sits_registration_statuses` `mr` on((`mr`.`reg_status` = `mp`.`reg_status`))) join `moodle_int_management`.`sits_memberships` `mm` on((`mm`.`mod_occ_bdo_id` = `mp`.`mod_occ_bdo_id`))) join `moodle_int_management`.`sits_registration_statuses` `rs` on((`rs`.`reg_status` = `mm`.`reg_status`))) join `moodle_int_management`.`sits_students` `st` on((`st`.`student_code` = `mm`.`student_code`))) join `moodle_int_management`.`sits_enrolment_statuses` `es` on((`es`.`enrolment_status` = `st`.`enrolment_status`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_departmentenrolment_full` AS select `mp`.`dpt_bdo_id` AS `map_bdo_id`,`mp`.`dpt_code` AS `map_department`,`mp`.`reg_status` AS `map_reg`,`mr`.`level` AS `map_level`,`mp`.`course_year` AS `map_year`,`mp`.`vle_courseid` AS `vle_courseid`,`mp`.`vle_idnumber` AS `vle_idnumber`,`mp`.`mapping_action` AS `mapping_action`,`mm`.`student_code` AS `student_code`,`st`.`username` AS `username`,`mm`.`mod_occ_bdo_id` AS `module_code`,`mm`.`mod_dpt_bdo_id` AS `department_code`,`mm`.`reg_status` AS `reg_status`,`mm`.`deleted` AS `membership_deleted`,`rs`.`level` AS `reg_level`,`ag`.`course_year` AS `course_year`,`ag`.`post_undergrad` AS `post_undergrad`,`ag`.`active` AS `assignment_active`,`st`.`enrolment_status` AS `enrolment_status`,`st`.`course_join_status` AS `course_join_status`,`st`.`deleted` AS `student_deleted`,`es`.`enrol` AS `enrol` from (((((((`moodle_int_management`.`sits_departments_mapping` `mp` join `moodle_int_management`.`sits_mapping_statuses` `ms` on(((`ms`.`vle_courseid` = `mp`.`vle_courseid`) and (`ms`.`mapping_active` = 'Y')))) join `moodle_int_management`.`sits_registration_statuses` `mr` on((`mr`.`reg_status` = `mp`.`reg_status`))) join `moodle_int_management`.`sits_memberships` `mm` on((`mm`.`mod_dpt_bdo_id` = `mp`.`dpt_bdo_id`))) join `moodle_int_management`.`sits_registration_statuses` `rs` on((`rs`.`reg_status` = `mm`.`reg_status`))) join `moodle_int_management`.`sits_students` `st` on((`st`.`student_code` = `mm`.`student_code`))) join `moodle_int_management`.`sits_assignments` `ag` on(((`ag`.`student_code` = `st`.`student_code`) and (((`ag`.`post_undergrad` = 'U') and (`ag`.`course_year` = `mp`.`course_year`)) or (`ag`.`post_undergrad` = `mp`.`course_year`) or isnull(`mp`.`course_year`))))) join `moodle_int_management`.`sits_enrolment_statuses` `es` on((`es`.`enrolment_status` = `st`.`enrolment_status`)));
 
/*interdependent layer 2*/
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_facultyenrolment_add` AS select `sits_v_facultyenrolment_full`.`map_faculty` AS `map_faculty`,`sits_v_facultyenrolment_full`.`map_year` AS `map_year`,`sits_v_facultyenrolment_full`.`vle_idnumber` AS `vle_idnumber`,`sits_v_facultyenrolment_full`.`vle_courseid` AS `vle_courseid`,`sits_v_facultyenrolment_full`.`mapping_action` AS `mapping_action`,`sits_v_facultyenrolment_full`.`student_code` AS `student_code`,`sits_v_facultyenrolment_full`.`username` AS `username`,`sits_v_facultyenrolment_full`.`faculty_code` AS `faculty_code`,`sits_v_facultyenrolment_full`.`course_year` AS `course_year`,`sits_v_facultyenrolment_full`.`post_undergrad` AS `post_undergrad`,`sits_v_facultyenrolment_full`.`assignment_active` AS `assignment_active`,`sits_v_facultyenrolment_full`.`enrolment_status` AS `enrolment_status`,`sits_v_facultyenrolment_full`.`course_join_status` AS `course_join_status`,`sits_v_facultyenrolment_full`.`student_deleted` AS `student_deleted`,`sits_v_facultyenrolment_full`.`enrol` AS `enrol` from `moodle_int_management`.`sits_v_facultyenrolment_full` where ((`sits_v_facultyenrolment_full`.`mapping_action` = 'ADD') and (`sits_v_facultyenrolment_full`.`assignment_active` = 'Y') and (`sits_v_facultyenrolment_full`.`course_join_status` = 'O') and (`sits_v_facultyenrolment_full`.`student_deleted` = 'N') and (`sits_v_facultyenrolment_full`.`enrol` = 'Y'));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_facultyenrolment_rmv` AS select `sits_v_facultyenrolment_full`.`map_faculty` AS `map_faculty`,`sits_v_facultyenrolment_full`.`map_year` AS `map_year`,`sits_v_facultyenrolment_full`.`vle_idnumber` AS `vle_idnumber`,`sits_v_facultyenrolment_full`.`vle_courseid` AS `vle_courseid`,`sits_v_facultyenrolment_full`.`mapping_action` AS `mapping_action`,`sits_v_facultyenrolment_full`.`student_code` AS `student_code`,`sits_v_facultyenrolment_full`.`username` AS `username`,`sits_v_facultyenrolment_full`.`faculty_code` AS `faculty_code`,`sits_v_facultyenrolment_full`.`course_year` AS `course_year`,`sits_v_facultyenrolment_full`.`post_undergrad` AS `post_undergrad`,`sits_v_facultyenrolment_full`.`assignment_active` AS `assignment_active`,`sits_v_facultyenrolment_full`.`enrolment_status` AS `enrolment_status`,`sits_v_facultyenrolment_full`.`course_join_status` AS `course_join_status`,`sits_v_facultyenrolment_full`.`student_deleted` AS `student_deleted`,`sits_v_facultyenrolment_full`.`enrol` AS `enrol` from `moodle_int_management`.`sits_v_facultyenrolment_full` where (not((`sits_v_facultyenrolment_full`.`vle_courseid`,`sits_v_facultyenrolment_full`.`student_code`) in (select `sits_v_facultyenrolment_add`.`vle_courseid`,`sits_v_facultyenrolment_add`.`student_code` from `moodle_int_management`.`sits_v_facultyenrolment_add`)));
 
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_programmeenrolment_add` AS select `sits_v_programmeenrolment_full`.`map_programme` AS `map_programme`,`sits_v_programmeenrolment_full`.`map_year` AS `map_year`,`sits_v_programmeenrolment_full`.`map_session` AS `map_session`,`sits_v_programmeenrolment_full`.`session_desc` AS `session_desc`,`sits_v_programmeenrolment_full`.`session_suffix` AS `session_suffix`,`sits_v_programmeenrolment_full`.`vle_idnumber` AS `vle_idnumber`,`sits_v_programmeenrolment_full`.`vle_courseid` AS `vle_courseid`,`sits_v_programmeenrolment_full`.`mapping_action` AS `mapping_action`,`sits_v_programmeenrolment_full`.`student_code` AS `student_code`,`sits_v_programmeenrolment_full`.`username` AS `username`,`sits_v_programmeenrolment_full`.`programme_code` AS `programme_code`,`sits_v_programmeenrolment_full`.`course_year` AS `course_year`,`sits_v_programmeenrolment_full`.`post_undergrad` AS `post_undergrad`,`sits_v_programmeenrolment_full`.`assignment_active` AS `assignment_active`,`sits_v_programmeenrolment_full`.`enrolment_status` AS `enrolment_status`,`sits_v_programmeenrolment_full`.`course_join_status` AS `course_join_status`,`sits_v_programmeenrolment_full`.`student_deleted` AS `student_deleted`,`sits_v_programmeenrolment_full`.`enrol` AS `enrol` from `moodle_int_management`.`sits_v_programmeenrolment_full` where ((`sits_v_programmeenrolment_full`.`mapping_action` = 'ADD') and (`sits_v_programmeenrolment_full`.`assignment_active` = 'Y') and (`sits_v_programmeenrolment_full`.`course_join_status` = 'O') and (`sits_v_programmeenrolment_full`.`student_deleted` = 'N') and (`sits_v_programmeenrolment_full`.`enrol` = 'Y'));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_programmeenrolment_rmv` AS select `sits_v_programmeenrolment_full`.`map_programme` AS `map_programme`,`sits_v_programmeenrolment_full`.`map_year` AS `map_year`,`sits_v_programmeenrolment_full`.`map_session` AS `map_session`,`sits_v_programmeenrolment_full`.`session_desc` AS `session_desc`,`sits_v_programmeenrolment_full`.`session_suffix` AS `session_suffix`,`sits_v_programmeenrolment_full`.`vle_idnumber` AS `vle_idnumber`,`sits_v_programmeenrolment_full`.`vle_courseid` AS `vle_courseid`,`sits_v_programmeenrolment_full`.`mapping_action` AS `mapping_action`,`sits_v_programmeenrolment_full`.`student_code` AS `student_code`,`sits_v_programmeenrolment_full`.`username` AS `username`,`sits_v_programmeenrolment_full`.`programme_code` AS `programme_code`,`sits_v_programmeenrolment_full`.`course_year` AS `course_year`,`sits_v_programmeenrolment_full`.`post_undergrad` AS `post_undergrad`,`sits_v_programmeenrolment_full`.`assignment_active` AS `assignment_active`,`sits_v_programmeenrolment_full`.`enrolment_status` AS `enrolment_status`,`sits_v_programmeenrolment_full`.`course_join_status` AS `course_join_status`,`sits_v_programmeenrolment_full`.`student_deleted` AS `student_deleted`,`sits_v_programmeenrolment_full`.`enrol` AS `enrol` from `moodle_int_management`.`sits_v_programmeenrolment_full` where (not((`sits_v_programmeenrolment_full`.`vle_courseid`,`sits_v_programmeenrolment_full`.`student_code`) in (select `sits_v_programmeenrolment_add`.`vle_courseid`,`sits_v_programmeenrolment_add`.`student_code` from `moodle_int_management`.`sits_v_programmeenrolment_add`)));
 
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_routeenrolment_add` AS select `sits_v_routeenrolment_full`.`map_route` AS `map_route`,`sits_v_routeenrolment_full`.`map_year` AS `map_year`,`sits_v_routeenrolment_full`.`map_session` AS `map_session`,`sits_v_routeenrolment_full`.`session_desc` AS `session_desc`,`sits_v_routeenrolment_full`.`session_suffix` AS `session_suffix`,`sits_v_routeenrolment_full`.`vle_idnumber` AS `vle_idnumber`,`sits_v_routeenrolment_full`.`vle_courseid` AS `vle_courseid`,`sits_v_routeenrolment_full`.`mapping_action` AS `mapping_action`,`sits_v_routeenrolment_full`.`student_code` AS `student_code`,`sits_v_routeenrolment_full`.`username` AS `username`,`sits_v_routeenrolment_full`.`route_code` AS `route_code`,`sits_v_routeenrolment_full`.`course_year` AS `course_year`,`sits_v_routeenrolment_full`.`post_undergrad` AS `post_undergrad`,`sits_v_routeenrolment_full`.`assignment_active` AS `assignment_active`,`sits_v_routeenrolment_full`.`enrolment_status` AS `enrolment_status`,`sits_v_routeenrolment_full`.`course_join_status` AS `course_join_status`,`sits_v_routeenrolment_full`.`student_deleted` AS `student_deleted`,`sits_v_routeenrolment_full`.`enrol` AS `enrol` from `moodle_int_management`.`sits_v_routeenrolment_full` where ((`sits_v_routeenrolment_full`.`mapping_action` = 'ADD') and (`sits_v_routeenrolment_full`.`assignment_active` = 'Y') and (`sits_v_routeenrolment_full`.`course_join_status` = 'O') and (`sits_v_routeenrolment_full`.`student_deleted` = 'N') and (`sits_v_routeenrolment_full`.`enrol` = 'Y'));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_routeenrolment_rmv` AS select `sits_v_routeenrolment_full`.`map_route` AS `map_route`,`sits_v_routeenrolment_full`.`map_year` AS `map_year`,`sits_v_routeenrolment_full`.`map_session` AS `map_session`,`sits_v_routeenrolment_full`.`session_desc` AS `session_desc`,`sits_v_routeenrolment_full`.`session_suffix` AS `session_suffix`,`sits_v_routeenrolment_full`.`vle_idnumber` AS `vle_idnumber`,`sits_v_routeenrolment_full`.`vle_courseid` AS `vle_courseid`,`sits_v_routeenrolment_full`.`mapping_action` AS `mapping_action`,`sits_v_routeenrolment_full`.`student_code` AS `student_code`,`sits_v_routeenrolment_full`.`username` AS `username`,`sits_v_routeenrolment_full`.`route_code` AS `route_code`,`sits_v_routeenrolment_full`.`course_year` AS `course_year`,`sits_v_routeenrolment_full`.`post_undergrad` AS `post_undergrad`,`sits_v_routeenrolment_full`.`assignment_active` AS `assignment_active`,`sits_v_routeenrolment_full`.`enrolment_status` AS `enrolment_status`,`sits_v_routeenrolment_full`.`course_join_status` AS `course_join_status`,`sits_v_routeenrolment_full`.`student_deleted` AS `student_deleted`,`sits_v_routeenrolment_full`.`enrol` AS `enrol` from `moodle_int_management`.`sits_v_routeenrolment_full` where (not((`sits_v_routeenrolment_full`.`vle_courseid`,`sits_v_routeenrolment_full`.`student_code`) in (select `sits_v_routeenrolment_add`.`vle_courseid`,`sits_v_routeenrolment_add`.`student_code` from `moodle_int_management`.`sits_v_routeenrolment_add`)));
 
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_moduleenrolment_add` AS select `sits_v_moduleenrolment_full`.`map_module` AS `map_module`,`sits_v_moduleenrolment_full`.`map_reg` AS `map_reg`,`sits_v_moduleenrolment_full`.`map_level` AS `map_level`,`sits_v_moduleenrolment_full`.`vle_courseid` AS `vle_courseid`,`sits_v_moduleenrolment_full`.`vle_idnumber` AS `vle_idnumber`,`sits_v_moduleenrolment_full`.`mapping_action` AS `mapping_action`,`sits_v_moduleenrolment_full`.`student_code` AS `student_code`,`sits_v_moduleenrolment_full`.`username` AS `username`,`sits_v_moduleenrolment_full`.`module_code` AS `module_code`,`sits_v_moduleenrolment_full`.`reg_status` AS `reg_status`,`sits_v_moduleenrolment_full`.`membership_deleted` AS `membership_deleted`,`sits_v_moduleenrolment_full`.`reg_level` AS `reg_level`,`sits_v_moduleenrolment_full`.`enrolment_status` AS `enrolment_status`,`sits_v_moduleenrolment_full`.`course_join_status` AS `course_join_status`,`sits_v_moduleenrolment_full`.`student_deleted` AS `student_deleted`,`sits_v_moduleenrolment_full`.`enrol` AS `enrol` from `moodle_int_management`.`sits_v_moduleenrolment_full` where ((`sits_v_moduleenrolment_full`.`mapping_action` = 'ADD') and (`sits_v_moduleenrolment_full`.`membership_deleted` = 'N') and (`sits_v_moduleenrolment_full`.`reg_level` >= `sits_v_moduleenrolment_full`.`map_level`) and (`sits_v_moduleenrolment_full`.`course_join_status` = 'O') and (`sits_v_moduleenrolment_full`.`student_deleted` = 'N') and (`sits_v_moduleenrolment_full`.`enrol` = 'Y'));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_moduleenrolment_rmv` AS select `sits_v_moduleenrolment_full`.`map_module` AS `map_module`,`sits_v_moduleenrolment_full`.`map_reg` AS `map_reg`,`sits_v_moduleenrolment_full`.`map_level` AS `map_level`,`sits_v_moduleenrolment_full`.`vle_courseid` AS `vle_courseid`,`sits_v_moduleenrolment_full`.`vle_idnumber` AS `vle_idnumber`,`sits_v_moduleenrolment_full`.`mapping_action` AS `mapping_action`,`sits_v_moduleenrolment_full`.`student_code` AS `student_code`,`sits_v_moduleenrolment_full`.`username` AS `username`,`sits_v_moduleenrolment_full`.`module_code` AS `module_code`,`sits_v_moduleenrolment_full`.`reg_status` AS `reg_status`,`sits_v_moduleenrolment_full`.`membership_deleted` AS `membership_deleted`,`sits_v_moduleenrolment_full`.`reg_level` AS `reg_level`,`sits_v_moduleenrolment_full`.`enrolment_status` AS `enrolment_status`,`sits_v_moduleenrolment_full`.`course_join_status` AS `course_join_status`,`sits_v_moduleenrolment_full`.`student_deleted` AS `student_deleted`,`sits_v_moduleenrolment_full`.`enrol` AS `enrol` from `moodle_int_management`.`sits_v_moduleenrolment_full` where ((not((`sits_v_moduleenrolment_full`.`vle_courseid`,`sits_v_moduleenrolment_full`.`student_code`) in (select `sits_v_moduleenrolment_add`.`vle_courseid`,`sits_v_moduleenrolment_add`.`student_code` from `moodle_int_management`.`sits_v_moduleenrolment_add`))) and ((`sits_v_moduleenrolment_full`.`reg_status` = 'REJ') or (`sits_v_moduleenrolment_full`.`reg_level` >= `sits_v_moduleenrolment_full`.`map_level`)));
 
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_departmentenrolment_add` AS select `sits_v_departmentenrolment_full`.`map_department` AS `map_department`,`sits_v_departmentenrolment_full`.`map_reg` AS `map_reg`,`sits_v_departmentenrolment_full`.`map_level` AS `map_level`,`sits_v_departmentenrolment_full`.`map_year` AS `map_year`,`sits_v_departmentenrolment_full`.`vle_courseid` AS `vle_courseid`,`sits_v_departmentenrolment_full`.`vle_idnumber` AS `vle_idnumber`,`sits_v_departmentenrolment_full`.`mapping_action` AS `mapping_action`,`sits_v_departmentenrolment_full`.`student_code` AS `student_code`,`sits_v_departmentenrolment_full`.`username` AS `username`,`sits_v_departmentenrolment_full`.`module_code` AS `module_code`,`sits_v_departmentenrolment_full`.`department_code` AS `department_code`,`sits_v_departmentenrolment_full`.`reg_status` AS `reg_status`,`sits_v_departmentenrolment_full`.`membership_deleted` AS `membership_deleted`,`sits_v_departmentenrolment_full`.`reg_level` AS `reg_level`,`sits_v_departmentenrolment_full`.`course_year` AS `course_year`,`sits_v_departmentenrolment_full`.`post_undergrad` AS `post_undergrad`,`sits_v_departmentenrolment_full`.`assignment_active` AS `assignment_active`,`sits_v_departmentenrolment_full`.`enrolment_status` AS `enrolment_status`,`sits_v_departmentenrolment_full`.`course_join_status` AS `course_join_status`,`sits_v_departmentenrolment_full`.`student_deleted` AS `student_deleted`,`sits_v_departmentenrolment_full`.`enrol` AS `enrol` from `moodle_int_management`.`sits_v_departmentenrolment_full` where ((`sits_v_departmentenrolment_full`.`mapping_action` = 'ADD') and (`sits_v_departmentenrolment_full`.`assignment_active` = 'Y') and (`sits_v_departmentenrolment_full`.`membership_deleted` = 'N') and (`sits_v_departmentenrolment_full`.`reg_level` >= `sits_v_departmentenrolment_full`.`map_level`) and (`sits_v_departmentenrolment_full`.`course_join_status` = 'O') and (`sits_v_departmentenrolment_full`.`student_deleted` = 'N') and (`sits_v_departmentenrolment_full`.`enrol` = 'Y'));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_departmentenrolment_rmv` AS select `sits_v_departmentenrolment_full`.`map_department` AS `map_department`,`sits_v_departmentenrolment_full`.`map_reg` AS `map_reg`,`sits_v_departmentenrolment_full`.`map_level` AS `map_level`,`sits_v_departmentenrolment_full`.`map_year` AS `map_year`,`sits_v_departmentenrolment_full`.`vle_courseid` AS `vle_courseid`,`sits_v_departmentenrolment_full`.`vle_idnumber` AS `vle_idnumber`,`sits_v_departmentenrolment_full`.`mapping_action` AS `mapping_action`,`sits_v_departmentenrolment_full`.`student_code` AS `student_code`,`sits_v_departmentenrolment_full`.`username` AS `username`,`sits_v_departmentenrolment_full`.`module_code` AS `module_code`,`sits_v_departmentenrolment_full`.`department_code` AS `department_code`,`sits_v_departmentenrolment_full`.`reg_status` AS `reg_status`,`sits_v_departmentenrolment_full`.`membership_deleted` AS `membership_deleted`,`sits_v_departmentenrolment_full`.`reg_level` AS `reg_level`,`sits_v_departmentenrolment_full`.`course_year` AS `course_year`,`sits_v_departmentenrolment_full`.`post_undergrad` AS `post_undergrad`,`sits_v_departmentenrolment_full`.`assignment_active` AS `assignment_active`,`sits_v_departmentenrolment_full`.`enrolment_status` AS `enrolment_status`,`sits_v_departmentenrolment_full`.`course_join_status` AS `course_join_status`,`sits_v_departmentenrolment_full`.`student_deleted` AS `student_deleted`,`sits_v_departmentenrolment_full`.`enrol` AS `enrol` from `moodle_int_management`.`sits_v_departmentenrolment_full` where ((not((`sits_v_departmentenrolment_full`.`vle_courseid`,`sits_v_departmentenrolment_full`.`student_code`) in (select `sits_v_departmentenrolment_add`.`vle_courseid`,`sits_v_departmentenrolment_add`.`student_code` from `moodle_int_management`.`sits_v_departmentenrolment_add`))) and ((`sits_v_departmentenrolment_full`.`reg_status` = 'REJ') or (`sits_v_departmentenrolment_full`.`reg_level` >= `sits_v_departmentenrolment_full`.`map_level`)));
 
 
/*interdependent layer 3*/
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_enrolmemberships_add` AS select `sits_v_facultyenrolment_add`.`vle_courseid` AS `vle_courseid`,`sits_v_facultyenrolment_add`.`student_code` AS `student_code`,`sits_v_facultyenrolment_add`.`username` AS `username`,'FAC' AS `map_type`,`sits_v_facultyenrolment_add`.`map_faculty` AS `map_code`,`sits_v_facultyenrolment_add`.`map_year` AS `map_year`,NULL AS `map_regstatus`,'ADD' AS `map_action` from `moodle_int_management`.`sits_v_facultyenrolment_add` union select `sits_v_programmeenrolment_add`.`vle_courseid` AS `vle_courseid`,`sits_v_programmeenrolment_add`.`student_code` AS `student_code`,`sits_v_programmeenrolment_add`.`username` AS `username`,'PRG' AS `map_type`,`sits_v_programmeenrolment_add`.`map_programme` AS `map_code`,`sits_v_programmeenrolment_add`.`map_year` AS `map_year`,NULL AS `map_regstatus`,'ADD' AS `map_action` from `moodle_int_management`.`sits_v_programmeenrolment_add` union select `sits_v_routeenrolment_add`.`vle_courseid` AS `vle_courseid`,`sits_v_routeenrolment_add`.`student_code` AS `student_code`,`sits_v_routeenrolment_add`.`username` AS `username`,'ROU' AS `map_type`,`sits_v_routeenrolment_add`.`map_route` AS `map_code`,`sits_v_routeenrolment_add`.`map_year` AS `map_year`,NULL AS `map_regstatus`,'ADD' AS `map_action` from `moodle_int_management`.`sits_v_routeenrolment_add` union select `sits_v_moduleenrolment_add`.`vle_courseid` AS `vle_courseid`,`sits_v_moduleenrolment_add`.`student_code` AS `student_code`,`sits_v_moduleenrolment_add`.`username` AS `username`,'MOD' AS `map_type`,`sits_v_moduleenrolment_add`.`map_module` AS `map_code`,NULL AS `map_year`,`sits_v_moduleenrolment_add`.`map_reg` AS `map_regstatus`,'ADD' AS `map_action` from `moodle_int_management`.`sits_v_moduleenrolment_add` union select `sits_v_departmentenrolment_add`.`vle_courseid` AS `vle_courseid`,`sits_v_departmentenrolment_add`.`student_code` AS `student_code`,`sits_v_departmentenrolment_add`.`username` AS `username`,'DPT' AS `map_type`,`sits_v_departmentenrolment_add`.`map_department` AS `map_code`,`sits_v_departmentenrolment_add`.`map_year` AS `map_year`,`sits_v_departmentenrolment_add`.`map_reg` AS `map_regstatus`,'ADD' AS `map_action` from `moodle_int_management`.`sits_v_departmentenrolment_add`;
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_enrolmemberships_rmv` AS select `sits_v_facultyenrolment_rmv`.`vle_courseid` AS `vle_courseid`,`sits_v_facultyenrolment_rmv`.`student_code` AS `student_code`,`sits_v_facultyenrolment_rmv`.`username` AS `username`,'FAC' AS `map_type`,`sits_v_facultyenrolment_rmv`.`map_faculty` AS `map_code`,`sits_v_facultyenrolment_rmv`.`map_year` AS `map_year`,NULL AS `map_regstatus`,'RMV' AS `map_action` from `moodle_int_management`.`sits_v_facultyenrolment_rmv` union select `sits_v_programmeenrolment_rmv`.`vle_courseid` AS `vle_courseid`,`sits_v_programmeenrolment_rmv`.`student_code` AS `student_code`,`sits_v_programmeenrolment_rmv`.`username` AS `username`,'PRG' AS `map_type`,`sits_v_programmeenrolment_rmv`.`map_programme` AS `map_code`,`sits_v_programmeenrolment_rmv`.`map_year` AS `map_year`,NULL AS `map_regstatus`,'RMV' AS `map_action` from `moodle_int_management`.`sits_v_programmeenrolment_rmv` union select `sits_v_routeenrolment_rmv`.`vle_courseid` AS `vle_courseid`,`sits_v_routeenrolment_rmv`.`student_code` AS `student_code`,`sits_v_routeenrolment_rmv`.`username` AS `username`,'ROU' AS `map_type`,`sits_v_routeenrolment_rmv`.`map_route` AS `map_code`,`sits_v_routeenrolment_rmv`.`map_year` AS `map_year`,NULL AS `map_regstatus`,'RMV' AS `map_action` from `moodle_int_management`.`sits_v_routeenrolment_rmv` union select `sits_v_moduleenrolment_rmv`.`vle_courseid` AS `vle_courseid`,`sits_v_moduleenrolment_rmv`.`student_code` AS `student_code`,`sits_v_moduleenrolment_rmv`.`username` AS `username`,'MOD' AS `map_type`,`sits_v_moduleenrolment_rmv`.`map_module` AS `map_code`,NULL AS `map_year`,`sits_v_moduleenrolment_rmv`.`map_reg` AS `map_regstatus`,'RMV' AS `map_action` from `moodle_int_management`.`sits_v_moduleenrolment_rmv` union select `sits_v_departmentenrolment_rmv`.`vle_courseid` AS `vle_courseid`,`sits_v_departmentenrolment_rmv`.`student_code` AS `student_code`,`sits_v_departmentenrolment_rmv`.`username` AS `username`,'DPT' AS `map_type`,`sits_v_departmentenrolment_rmv`.`map_department` AS `map_code`,`sits_v_departmentenrolment_rmv`.`map_year` AS `map_year`,`sits_v_departmentenrolment_rmv`.`map_reg` AS `map_regstatus`,'RMV' AS `map_action` from `moodle_int_management`.`sits_v_departmentenrolment_rmv`;
 
/*interdependent layer 4*/
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_enrolmembership_maps` AS select `sits_v_enrolmemberships_add`.`vle_courseid` AS `vle_courseid`,`sits_v_enrolmemberships_add`.`student_code` AS `student_code`,`sits_v_enrolmemberships_add`.`username` AS `username`,`sits_v_enrolmemberships_add`.`map_type` AS `map_type`,`sits_v_enrolmemberships_add`.`map_code` AS `map_code`,`sits_v_enrolmemberships_add`.`map_year` AS `map_year`,`sits_v_enrolmemberships_add`.`map_regstatus` AS `map_regstatus`,`sits_v_enrolmemberships_add`.`map_action` AS `map_action` from `moodle_int_management`.`sits_v_enrolmemberships_add` union select `sits_v_enrolmemberships_rmv`.`vle_courseid` AS `vle_courseid`,`sits_v_enrolmemberships_rmv`.`student_code` AS `student_code`,`sits_v_enrolmemberships_rmv`.`username` AS `username`,`sits_v_enrolmemberships_rmv`.`map_type` AS `map_type`,`sits_v_enrolmemberships_rmv`.`map_code` AS `map_code`,`sits_v_enrolmemberships_rmv`.`map_year` AS `map_year`,`sits_v_enrolmemberships_rmv`.`map_regstatus` AS `map_regstatus`,`sits_v_enrolmemberships_rmv`.`map_action` AS `map_action` from `moodle_int_management`.`sits_v_enrolmemberships_rmv` where (not((`sits_v_enrolmemberships_rmv`.`vle_courseid`,`sits_v_enrolmemberships_rmv`.`student_code`) in (select `sits_v_enrolmemberships_add`.`vle_courseid`,`sits_v_enrolmemberships_add`.`student_code` from `moodle_int_management`.`sits_v_enrolmemberships_add`)));
 
/*interdependent layer 5*/
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_enrolmemberships` AS select distinct `cr`.`id` AS `vle_courseid`,`cr`.`idnumber` AS `vle_idnumber`,`em`.`student_code` AS `student_code`,`em`.`username` AS `username`,`em`.`map_action` AS `map_action` from (`moodle_int_management`.`sits_v_enrolmembership_maps` `em` join `uclmoodleprod`.`mdl_course` `cr` on((`cr`.`id` = `em`.`vle_courseid`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_enrolstudents` AS select `moodle_int_management`.`sits_students`.`id` AS `id`,`moodle_int_management`.`sits_students`.`student_code` AS `student_code`,`moodle_int_management`.`sits_students`.`username` AS `username`,`moodle_int_management`.`sits_students`.`upi` AS `upi`,`moodle_int_management`.`sits_students`.`firstname` AS `firstname`,`moodle_int_management`.`sits_students`.`surname` AS `surname`,`moodle_int_management`.`sits_students`.`student_name` AS `student_name`,`moodle_int_management`.`sits_students`.`email` AS `email`,`moodle_int_management`.`sits_students`.`dpt_bdo_id` AS `department_code`,`moodle_int_management`.`sits_students`.`enrolment_status` AS `enrolment_status`,`moodle_int_management`.`sits_students`.`course_join_status` AS `course_join_status`,`moodle_int_management`.`sits_students`.`deleted` AS `deleted`,`moodle_int_management`.`sits_students`.`last_updated` AS `last_updated` from `moodle_int_management`.`sits_students` where `moodle_int_management`.`sits_students`.`student_code` in (select `sits_v_facultyenrolment_full`.`student_code` from `moodle_int_management`.`sits_v_facultyenrolment_full` union select `sits_v_programmeenrolment_full`.`student_code` from `moodle_int_management`.`sits_v_programmeenrolment_full` union select `sits_v_routeenrolment_full`.`student_code` from `moodle_int_management`.`sits_v_routeenrolment_full` union select `sits_v_moduleenrolment_add`.`student_code` from `moodle_int_management`.`sits_v_moduleenrolment_add` union select `sits_v_moduleenrolment_rmv`.`student_code` from `moodle_int_management`.`sits_v_moduleenrolment_rmv` union select `sits_v_departmentenrolment_add`.`student_code` from `moodle_int_management`.`sits_v_departmentenrolment_add` union select `sits_v_departmentenrolment_rmv`.`student_code` from `moodle_int_management`.`sits_v_departmentenrolment_rmv`);
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_enrolcourse_ids` AS select `sits_v_facultyenrolment_full`.`vle_courseid` AS `vle_courseid` from `moodle_int_management`.`sits_v_facultyenrolment_full` union select `sits_v_programmeenrolment_full`.`vle_courseid` AS `vle_courseid` from `moodle_int_management`.`sits_v_programmeenrolment_full` union select `sits_v_routeenrolment_full`.`vle_courseid` AS `vle_courseid` from `moodle_int_management`.`sits_v_routeenrolment_full` union select `sits_v_moduleenrolment_add`.`vle_courseid` AS `vle_courseid` from `moodle_int_management`.`sits_v_moduleenrolment_add` union select `sits_v_moduleenrolment_rmv`.`vle_courseid` AS `vle_courseid` from `moodle_int_management`.`sits_v_moduleenrolment_rmv` union select `sits_v_departmentenrolment_add`.`vle_courseid` AS `vle_courseid` from `moodle_int_management`.`sits_v_departmentenrolment_add` union select `sits_v_departmentenrolment_rmv`.`vle_courseid` AS `vle_courseid` from `moodle_int_management`.`sits_v_departmentenrolment_rmv`;
 
/*interdependent layer 6*/
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_enrolcourses` AS select `cr`.`id` AS `vle_courseid`,`cr`.`idnumber` AS `vle_idnumber`,`cr`.`fullname` AS `course_name`,`cr`.`category` AS `category_id`,`ct`.`name` AS `category_name` from ((`uclmoodleprod`.`mdl_course` `cr` left join `uclmoodleprod`.`mdl_course_categories` `ct` on((`ct`.`id` = `cr`.`category`))) join `moodle_int_management`.`sits_v_enrolcourse_ids` `en` on((`en`.`vle_courseid` = `cr`.`id`)));


SET NAMES 'utf8mb4' COLLATE 'utf8mb4_general_ci';
DROP VIEW moodle_int_management.sits_v_thresholds;
CREATE ALGORITHM=UNDEFINED DEFINER=`moodle_int_management`@`%` SQL SECURITY DEFINER VIEW `moodle_int_management`.`sits_v_thresholds` AS select 'students' AS `import_type`,count(`st`.`student_code`) AS `total_now`,count(`si`.`student_code`) AS `total_import`,`sp`.`setting` AS `threshold`,`so`.`setting` AS `override`,((count(`st`.`student_code`) * `sp`.`setting`) / 100) AS `threshold_check`,(case when (((count(`st`.`student_code`) * `sp`.`setting`) / 100) > count(`si`.`student_code`)) then 'breach' else 'safe' end) AS `threshold_action` from (((`moodle_int_management`.`sits_students` `st` join `moodle_int_management`.`system_settings` `sp` on((`sp`.`title` = 'threshold_percent'))) join `moodle_int_management`.`system_settings` `so` on((`so`.`title` = 'threshold_override'))) left join `moodle_int_management`.`sits_students_dump` `si` on((`st`.`student_code` = `si`.`student_code`))) where (`st`.`deleted` = 'N') group by `sp`.`setting`,`so`.`setting` union select 'memberships' AS `import_type`,count(`mm`.`student_code`) AS `total_now`,count(`mi`.`student_code`) AS `total_import`,`sp`.`setting` AS `threshold`,`so`.`setting` AS `override`,((count(`mm`.`student_code`) * `sp`.`setting`) / 100) AS `threshold_check`,(case when (((count(`mm`.`student_code`) * `sp`.`setting`) / 100) > count(`mi`.`student_code`)) then 'breach' else 'safe' end) AS `threshold_action` from (((`moodle_int_management`.`sits_memberships` `mm` join `moodle_int_management`.`system_settings` `sp` on((`sp`.`title` = 'threshold_percent'))) join `moodle_int_management`.`system_settings` `so` on((`so`.`title` = 'threshold_override'))) left join `moodle_int_management`.`sits_memberships_dump` `mi` on(((`mm`.`student_code` = `mi`.`student_code`) and (`mm`.`mod_occ_bdo_id` = `mi`.`mod_occ_bdo_id`)))) where (`mm`.`deleted` = 'N') group by `sp`.`setting`,`so`.`setting`;
SET NAMES 'utf8mb4' COLLATE 'utf8mb4_0900_ai_ci';
```

+ drop & re-create stored procedures
