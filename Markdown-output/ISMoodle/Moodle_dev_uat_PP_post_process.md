# Moodle dev/uat/PP post process

Things to do after creating a dev/uat/PP Moodle instance.

That particularly applies if you copied the database from a prod backup.

If it's not the case, you probably won't need to read this page.

**If you face the error "error\\The instance is not properly configured, invalid path." - just comment out this line  <https://github.com/moodle/moodle/blob/master/repository/filesystem/lib.php#L652>**

Sometimes we use different methods to execute commands, when that's the case, you only need to use one.

Either:  

- using SQL

- using the shell

- using [moosh](http://moosh-online.com/) 

moosh should be already installed, you just have to copy and paste.

If for some reason it is not installed you can fall back on another method (or install it).

If you want you can see the following sub pages separately:

[Post process with SQL](Post_process_with_SQL)
[Post process from command line](Post_process_from_command_line)

**Edit email addresses (if you think it is needed) - keep in mind the config\_local.php are set to send no email ever**

run the following SQL query

``` sql
-- Set email address to black hole for all but moodl/trail accounts.
UPDATE mdl_user
SET email =  'nobody@ucl.ac.uk'
WHERE id  NOT IN (
     SELECT A.id FROM mdl_user A
     WHERE A.username  LIKE 'moodl%' OR A.username  LIKE 'trail%'
);
```

Later versions of msql may give an error message, if this occurs use:

``` sql
-- Set email address to black hole for all but moodl/trail accounts.
UPDATE mdl_user
SET email =  'nobody@ucl.ac.uk'
WHERE username NOT LIKE 'moodl%' OR username  NOT LIKE 'trail%';
```

### Update sits filter views

To update dependent views in the appropriate `moodle_sits_management_???2` database, execute the SQL which is generated by the following to recreate each of the views...

\*\*This may not be needed for moodle pp refresh\*\*

``` sql
SELECT
     TABLE_SCHEMA
   , TABLE_NAME
   , CONCAT( 'CREATE OR REPLACE VIEW ' , TABLE_SCHEMA,  '.' , TABLE_NAME,  ' AS ' ,
            REPLACE (VIEW_DEFINITION,  '`moodle_live`.' ,  '`moodle_devxxxx`.' ),  ';' )  AS sql_create
FROM information_schema.VIEWS
WHERE TABLE_SCHEMA =  'moodle_sits_management_dev2'
AND VIEW_DEFINITION  LIKE '%`moodle_live`.%' ;
```

### Update CMIS token - OUTDATED/IRRELEVANT?

Find the correct token for moodle-pp; ssh into the server

> ssh ccspmdl@moodle-admin-pp

open the file '**/usr/local/sits\_filter2/app/Controller/RestConfig.php**'

Towards the end of the file you'll find the appropriate token for moodle-pp. Copy the token somewhere.

Connect to the PP database

The following query will give you the list of external services:

> select \* from mdl\_external\_services;

The id of the 'cmis webservice' should be: **5**

The following query should show you what token is stored in the database:

> select
> s.id 'service id', s.name 'service name',
> t.id 'token id', t.token 'token', FROM\_UNIXTIME(t.timecreated, '%d/%m/%Y') 'timecreated',
> concat(u.firstname , ' ', u.lastname) 'creator'
> from mdl\_external\_services s
> join mdl\_external\_tokens t on t.externalserviceid = s.id
> join mdl\_user u on u.id = t.creatorid
> where s.id = 5;

You should have an output similar to:

+------------+-----------------+----------+----------------------------------+-------------+---------------+
| service id | service name | token id | token | timecreated | creator |
+------------+-----------------+----------+----------------------------------+-------------+---------------+
| 5 | cmis webservice | 109 | \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* | 07/09/2015 | Admin User |
| 5 | cmis webservice | 357 | \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* | 15/09/2016 | Alexis Nelson |
+------------+-----------------+----------+----------------------------------+-------------+---------------+

The token we want to replace is the one created on **15/09/2016**

Make a note of the token ID; in this case: 357

Update the token as appropriate:

> update mdl\_external\_tokens set token = '\*\*\*\*\*\*\*' where id = 357;

### **Set site name in Frontpage settings**

`Site administration >> Front page >> Front page settings`

**Set cookie prefix**

##### admin-&gt;server-&gt;session handling

``` bash
moosh config-set sessioncookie ucl_devxxxxxx
```

OR

`Site administration >> Server >> Session handling`

### Edit Blacboard collaborate settings

``` bash
moosh config-set elluminate_server 'https://eu1.bbcollab.com/site/external/adapter/default/v3'
moosh config-set elluminate_auth_username 'UCLEUMOODLETEST'
moosh config-set elluminate_auth_password '<in KeePass>'
```

OR

``` sql
-- Set Blackboard Collaborate to use test account (details in KeePass).
UPDATE mdl_config  SET `value` =  'https://eu1.bbcollab.com/site/external/adapter/default/v3'  WHERE ` name ` =  'elluminate_server' ;
UPDATE mdl_config  SET `value` =  'UCLEUMOODLETEST' WHERE ` name ` =  'elluminate_auth_username' ;
UPDATE mdl_config  SET `value` =  '<in KeePass>' WHERE ` name ` =  'elluminate_auth_password' ;
```

### Edit MyFeedback settings

    Go to 'admin/settings.php?section=reportmyfeedback'

Delete the settings for: **'DB Host', 'DB Name', 'DB Username', 'DB Password**'.

### Global string replace (host URL)

``` java
php admin/tool/replace/cli/replace.php --search=' https://moodle.ucl.ac.uk ' --replace='https://vxx.moodle-dev.ucl.ac.uk' --non-interactive
```

OR

-   `https://moodle-snapshot.ucl.ac.uk/16-17/admin/tool/replace/`
    -   `Search:  ' https://moodle.ucl.ac.uk ' `
    -   `Replace: 'https://vxx.moodle-dev.ucl.ac.uk'`

### Changes to site settings:

##### Remove guest login button - settings-&gt;siteadmin-&gt;plugins-&gt;authentication-&gt;manage auth-&gt;login button=hide

     

``` bash
moosh config-set guestloginbutton 0
```

##### Security &gt; Site policies &gt; Site policy URL = http://moodle-archive.ucl.ac.uk/yy-yy/policy/about\_the\_archive.html (update yy with 10-11, 11-12 etc)

     

``` bash
moosh config-set sitepolicy ''
moosh config-set sitepolicyguest ''
```

##### **mdl\_course** = set all guest access to 0 and all enrolment options to 0

##### this disables all enrolments, guest functionality and student course ‘browsing’ 

     

``` bash
moosh config-set logguests 0
moosh config-set allowguestmymoodle 0
moosh config-set autologinguests 0 
moosh config-set enrol_plugins_enabled ""
moosh config-set allowunenroll 0
moosh config-set allow_mass_enroll_feature 0 #just in case
```

##### 2. Modify local\_settings.php:

###### a. Change dbhost to 'moodle-snapshot.ucl.ac.uk'

     

``` bash
sed -i s/${OLD_HOST}/${NEW_HOST}/g local_settings.php
```

###### b. Change dbname 

     

``` bash
sed -i s/${OLD_DATABASE}/${NEW_DATABASE}/g local_settings.php
```

###### d. Change dirroot 

     

``` bash
sed -i s/${OLD_DIRROOT}/${NEW_DIRROOT}/g local_settings.php
```

###### e. Change dataroot to '/data/moodle'

     

``` bash
sed -i s/${OLD_DATAROOT}/${NEW_DATAROOT}/g local_settings.php
```

##### 3. Make other changes as required, especially noemailever = true.

     

``` java
moosh config-set noemailever 1
```

OR

you can set $CFG-&gt;noemailever = true; in local\_settings.php

## Attachments:

<img src="images/icons/bullet_blue.gif" width="8" height="8" /> [capabilities\_staff\_readonly.txt](attachments/96699178/96699176.txt) (text/plain)
<img src="images/icons/bullet_blue.gif" width="8" height="8" /> [capabilities\_student\_readonly.txt](attachments/96699178/96699177.txt) (text/plain)

